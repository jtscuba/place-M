// refresh
const modhash = window.reddit.modhash;
var run_counter = 0;
const script_file_loc = "https://raw.githack.com/jtscuba/place-M/master/script_manger.js";
const draw = null;
const time_out = 3600;

var sec = 0;

async function delay(amount) {
  return new Promise((resolve) => {
    setTimeout(resolve, amount);
  });
};

const load_script = () => {
   $.getScript(script_file_loc)
   .done(res => {
      draw = setInterval( () => {
         draw_pixel();
         sec = 300;
      }, 300000);
   })
   .fail(err => {
      console.log(err);
   })
}

setInterval(() => {
   if (sec > 0) {
      console.log("Drawing in " + (sec) + " seconds");
      sec--;
   }

   run_counter++;

   if ((run_counter % time_out) == 0 && draw != null) {
      clearInterval(draw);
      load_script();
   }
   	
}, 1e3);


const five_minutes_in_ms = 300000;

const logo_colors = 
        [[3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
         [3, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3],
         [3, 8, 8,13,13, 8, 8, 8,13,13, 8, 8, 8, 8,13,13,13, 8, 8,13, 8, 8, 8, 8,13, 8, 8,13, 8,13,13,13,13, 8, 3],
         [3, 8,13, 8, 8, 8, 8,13, 8, 8,13, 8, 8, 8,13, 8, 8,13, 8,13, 8, 8, 8, 8,13, 8, 8,13, 8,13, 8, 8, 8, 8, 3],
         [3, 8,13, 8,13,13, 8,13, 8, 8,13, 8, 8, 8,13,13,13, 8, 8,13, 8, 8, 8, 8,13, 8, 8,13, 8,13,13,13, 8, 8, 3],
         [3, 8,13, 8, 8,13, 8,13, 8, 8,13, 8, 8, 8,13, 8, 8,13, 8,13, 8, 8, 8, 8,13, 8, 8,13, 8,13, 8, 8, 8, 8, 3],
         [3, 8, 8,13,13, 8, 8, 8,13,13, 8, 8, 8, 8,13,13,13, 8, 8,13,13,13,13, 8,13,13,13,13, 8,13,13,13,13, 8, 3],
         [3, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 8, 8, 8, 8,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13,13, 8, 8, 8,13,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8, 8, 8,13,13,13,13,13, 8,13,13,13,13,13,13,13, 8,13,13,13,13,13, 8, 8, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8, 8, 8,13,13,13,13,13, 8, 8,13,13,13,13,13, 8, 8,13,13,13,13,13, 8, 8, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8, 8, 8,13,13,13,13,13, 8, 8, 8,13,13,13, 8, 8, 8,13,13,13,13,13, 8, 8, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8, 8, 8,13,13,13,13,13, 8, 8, 8, 8,13, 8, 8, 8, 8,13,13,13,13,13, 8, 8, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8,13,13,13,13,13,13,13,13,13, 8, 8, 8, 8, 8, 3],
         [3, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 3],
         [3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3]];

// Location constants
const x_min = 70;
const x_max = x_min + logo_colors[0].length;

const y_min = 802;
const y_max = y_min + logo_colors.length;

const draw_pixel = () => {
    sec = 0;
    for (y = y_min; y < y_max; y++) {
        for (x = x_min; x < x_max; x++) {
            $.get("https://www.reddit.com/api/place/pixel.json?x=" + x + "&y=" + y)
            .then(res => {
                // Get the desired color
                const color = logo_colors[y - y_min][x - x_min]

                // check if the color is already correct
                if (res.color == color) {
                   console.log("Skipping " + (x + ", " + y) + " because it's already correct");
                }
                else {
                   // If not fix it
                   console.log("Drawing at " + x + ", " + y + " (https://www.reddit.com/r/place/#x=" + x + "&y=" + y + ")");
                   $.ajax({ url: "https://www.reddit.com/api/place/draw.json", type: "POST",
                       headers: { "x-modhash": modhash }, data: { x: x, y: y, color: color }
                   })

                   return;
                }

            })
            .fail(err => {
                console.log(err);
                return;
            });

            // rate limiting
            await delay(50);
        }
    }
}